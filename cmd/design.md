# `dog`: Code Generator Design Specification

## 1. Core Goal

The core goal of `dog` (short for **d**vo **o**bject **g**enerator) is to **automatically generate type-safe field definitions for structs that implement the `entity.Entity` interface**. This completely replaces the use of "magic strings" in the construction of `dvo.Schema`, thereby improving code robustness, maintainability, and refactoring safety.

## 2. Core Feature: Automatic Discovery

`dog`'s most powerful feature is its **zero-configuration automatic discovery capability**. Developers **do not** need to manually register or list their entities. The tool automatically scans specified Go packages (e.g., the entire project `./...`) and intelligently identifies all structs that satisfy the `entity.Entity` interface contract, then generates the corresponding code for them.

This makes the integration process extremely simple and ensures that any new entity in the project can be seamlessly and automatically incorporated into `dvo`'s type-safe system.

## 3. Invocation

- The tool will be a standalone command-line application named `dog`.
- It is recommended to invoke it within a project using the `//go:generate dog [package-pattern]` directive, for example `//go:generate dog ./...` to scan the entire project.

## 4. Code Generation Logic

For each `struct` that is **automatically discovered** as an `Entity` (e.g., `entity.Product`), `dog` will perform the following actions:

1.  **Create Output Directory**: Under the specified output root path (defaults to `gen/`), it creates a subdirectory named after the entity `struct` in lowercase (e.g., `gen/your-project/entity/product/`), to ensure the uniqueness of `import` paths and perfectly resolve naming conflicts.
2.  **Create Generated File**: In this subdirectory, it creates a file named `[entity_name]_gen.go` (e.g., `product_gen.go`).
3.  **Populate File Content**: Using the `text/template` package, it writes the core logic into this file, including the package declaration, necessary imports, and the field factory definitions.

## 5. Generated Code Specification

For an entity like `entity.Product`, the content of the generated `gen/your-project/entity/product/product_gen.go` file must strictly adhere to the following template:

```go
// Code generated by dog. DO NOT EDIT.
package product

import (
	"fmt"
	"github.com/kcmvp/dvo"
	"github.com/kcmvp/dvo/constraint"
	"your-project/entity" // Import the package where the original Entity is defined
)

// _table is a package-level variable to store the table name, avoiding repeated calls.
var _table = entity.Product{}.Table()

// _persistentField is a generic helper function to create a PersistentField.
// It encapsulates the logic of creating a fully qualified field name.
func _persistentField[T constraint.FieldType](name string) entity.PersistentField[entity.Product] {
	return func(vfs ...constraint.ValidateFunc[T]) dvo.FieldProvider {
		// The ValidateFunc conversion is a placeholder for a more advanced implementation.
		// For now, we assume dvo.Field can handle this.
		return dvo.Field[T](fmt.Sprintf("%s.%s", _table, name), vfs...)
	}
}

// Fields contains all field definitions for the Product entity.
var (
	Name  = _persistentField[string]("Name")
	Price = _persistentField[float64]("Price")
)
```

*(**Design Note**: The `_persistentField` helper is generated as a private function within each package to ensure it is bound to the correct entity (`entity.Product`) and its corresponding table name. The final field variables (`Name`, `Price`) are exported for public use.)*

## 6. End-User Experience

1.  A developer defines their `entity.Product` struct.
2.  They add the `//go:generate dog [package-pattern]` directive in one of the files in the `entity` package (e.g., `//go:generate dog ./...`).
3.  They run `go generate ./...` in their terminal.
4.  The `dog` tool automatically creates the `gen/your-project/entity/product/product_gen.go` file.
5.  In their business logic, the developer can now use the generated fields in a type-safe manner by importing the generated package:

```go
import "your-project/gen/entity/product"

var productSchema = dvo.WithFields(
    product.Name(constraint.MinLength(1)),
    product.Price(constraint.Gt(0)),
)
```
